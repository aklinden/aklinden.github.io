# Create Smarter Dynamic Groups with Set-EntraIDExtensionAttributes 
---

## tl;dr

1. Generate extensionAttribute using `distinguishedname` property on Active Directory device objects.
2. Find Entra ID objects that match the name of the On Prem object.
3. Compare extensionAttributes between On Prem and Entra ID computer objects. 
4. Update the Entra ID extensionAttributes based on data from On Prem object. 

You can find the full script [here](https://github.com/aklinden/Set-EntraIDExtensionAttributes)

---

## Creating the script

### Introduction

The idea for this script came from someone in our software deployment team who wasn't satisfied with the way we were building dynamic groups in Entra ID. Rather than some kind of real property that marked a device from PDX, our dynamic group rules were something like `(device.deviceName -startsWith "P-") -or (device.deviceName -startsWith "PDX")`. This was fine for the most part, but what happens when someone names a device incorrectly? What if someone moves to another office and we forget to change the name of their device? This method left a lot of room for human error, and the dynamic groups weren't matching up as closely to our Active Directory groups as we wanted them to. After some research, software deployment guy found that extensionAttributes could be used in Entra ID, and that we hadn't been using them in Active Directory device objects until this point.  

### Creating extensionAttributes

 After talking it over with a larger group we decided that the three attributes that made the most sense were Office, Department, and device type. The location of a device object in our AD hierarchy would give us all of this info, so it was just a matter of retrieving the data - the `Get-ExtensionAttributes` function.  

 Since the `distinguishedname` property contains each of the properties I needed, I had to learn how to extract this information and it had to be dynamic. Up until this point, I hadn't really used a switch construct for much of anything (and I've probably only used it once or twice since) but it seemed to be perfect for the job.  
 
 "Here's a list of offices, if you see one of these, that's the device's office."  

 Now that I've created a way to pull the data I wanted, I figured the next (and last) step would be using `Set-ADComputer` to set the extensionAttributes on the on prem computer object and Entra Connect would take care of the rest. We just needed to tick the box in the wizard, force a sync, and we'd be changing the rules for our dynamic groups in no time, right?  

### Fine. We'll take the long way around.  

 Well, it turns out there was no option to include extensionAttributes in device properties that Entra Connect could sync (this is only available for user objects), the task shifted to pulling the current extensionAttributes for a device in Entra ID, comparing them when the results generated by `Get-ExtensionAttributes`, and pushing any changes up to Entra ID. At the time, I had only been using the Powershell modules and was struggling to find a way to read and write a device objects extensionAttributes in Entra ID. I could see the extensionAttributes through Graph Explorer, but didn't understand how to access them through `Get-MgDevice`.

 Eventually, I landed on the following HTTP request that would return the data I needed to create a custom PSobject 

 <pre>$filter = "$($AzureID)?`$select=id,deviceid,displayname,extensionAttributes,trustType" 
 $uri = "https://graph.microsoft.com/v1.0/devices/$filter" 
 $response = Invoke-MgGraphRequest -Method GET -Uri $uri</pre>  

  > **Note:**
  > Months later, (while writing this) I discovered how to do this through `Get-MgDevice`:
  > <pre>$test = Get-MgDevice -Filter "startswith(displayName, '$env:COMPUTERNAME')" -ConsistencyLevel eventual
  > $test[0].AdditionalProperties.extensionAttributes</pre>

With the hard part out of the way, I wrote a function that would do the comparing for us, then push the changes up to Entra ID.   

### Looking back  

It's been 7 months since I originally wrote this script and put it into production. Looking back on it, the inconsistency in using the built-in cmdlets and the HTTP request is a bit ugly, and this script would probably take forever to run in an environment that had several thousand devices, since it's making multiple API calls for a single device. I'll need to revisit this script and make some changes once we start to move into Entra joined rather than hybrid joined, but I think it works just fine for now.  

I'd also like to think u/PinchesTheCrab on reddit for [their feedback](https://www.reddit.com/r/PowerShell/comments/1h1hb1w/comment/lzc3a3o/?utm_source=share&utm_medium=web3x&utm_name=web3xcss&utm_term=1&utm_content=share_button). Since I took the self study method with powershell, there are probably a ton of little things I'm not in the habbit from doing. I'm not asking that you help me write a better script, but if you'd like to point out any best practices I'm not using, I welcome the criticism. 